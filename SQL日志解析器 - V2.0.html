<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQLæ—¥å¿—è§£æå™¨</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --background: #f8f9fa;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --text-color: #333;
            --text-secondary: #666;
            --code-bg: #f5f7fa;
            --json-bg: #fff8e1;
            --input-bg: #f8fafc;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: var(--background);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--secondary-color);
        }

        h1 {
            color: var(--primary-color);
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        h2, h3 {
            color: var(--primary-color);
            margin-bottom: 0;
        }

        h2 {
            font-size: 1.5rem;
        }

        h3 {
            font-size: 1.2rem;
        }

        .btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-reset {
            background: var(--danger-color);
        }

        .btn-reset:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: var(--warning-color);
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-success:hover {
            background: #219653;
        }

        .btn-info {
            background: #9b59b6;
        }

        .btn-info:hover {
            background: #8e44ad;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .sql-textarea {
            width: 100%;
            min-height: 300px;
            padding: 16px;
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--code-bg);
            resize: vertical;
            /* å¯ç”¨è‡ªåŠ¨æ¢è¡Œ */
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-all;
            overflow-wrap: break-word;
        }

        .sql-textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .params-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
            margin-top: 16px;
        }

        @media (max-width: 1200px) {
            .params-container {
                grid-template-columns: 1fr;
            }
        }

        .json-editor {
            width: 100%;
            min-height: 300px;
            padding: 16px;
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--json-bg);
            resize: vertical;
        }

        .json-editor:focus {
            outline: none;
            border-color: var(--warning-color);
            box-shadow: 0 0 0 2px rgba(243, 156, 18, 0.2);
        }

        .params-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .params-table th {
            background: #f1f5f9;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
        }

        .params-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .params-table tr:hover {
            background: #f8fafc;
        }

        .param-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .param-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .param-type {
            display: inline-block;
            padding: 2px 8px;
            background: #e3f2fd;
            color: var(--secondary-color);
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .full-sql-container {
            position: relative;
        }

        .full-sql {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 6px;
            padding: 20px;
            margin-top: 12px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            border: 1px solid #333;
        }

        .sql-keyword {
            color: #569cd6;
        }

        .sql-string {
            color: #ce9178;
        }

        .sql-number {
            color: #b5cea8;
        }

        .sql-comment {
            color: #6a9955;
        }

        .sql-param {
            color: #9cdcfe;
            background: rgba(156, 220, 254, 0.1);
            padding: 0 2px;
            border-radius: 2px;
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-title h3 {
            margin-bottom: 0;
        }

        .json-format-btn {
            background: var(--warning-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .json-format-btn:hover {
            background: #d68910;
        }

        .error-message {
            background: #fee;
            color: var(--danger-color);
            padding: 12px;
            border-radius: 4px;
            margin-top: 8px;
            border-left: 4px solid var(--danger-color);
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .card {
                padding: 16px;
            }
            
            .params-table {
                font-size: 14px;
            }
            
            .params-table th,
            .params-table td {
                padding: 8px 12px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .btn-group {
                width: 100%;
            }
            
            .btn-group .btn {
                flex: 1;
            }
            
            .init-inputs {
                flex-direction: column;
            }
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            box-shadow: var(--shadow);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.info {
            background: var(--secondary-color);
        }

        .parse-hint {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        .parse-count {
            font-weight: bold;
        }
        
        .datetime-input {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
        }
        
        .init-inputs {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .init-input {
            flex: 1;
        }
        
        .init-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .init-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            resize: vertical;
        }
        
        .init-textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .init-example {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            line-height: 1.4;
        }
        
        .init-example code {
            background: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .close-btn:hover {
            background: #f0f0f0;
        }
        
        .paste-tip {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        
        .paste-tip code {
            background: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        footer a:hover {
        background: #e3f2fd;
        color: #2980b9;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }

        footer a:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SQLæ—¥å¿—è§£æå™¨</h1>
            <span style="background: #ff6b6b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
            KuangMaster
        </span>
            <p class="subtitle">ç¼–è¾‘SQLè¯­å¥å’Œå‚æ•°JSONï¼Œå®æ—¶è§£æå¹¶ç”Ÿæˆå®Œæ•´SQL - PostgreSQLä¸“ç”¨</p>
        </header>

        <!-- æ•°æ®åˆå§‹åŒ–çª—å£ -->
        <div class="card">
            <div class="card-header">
                <h2>æ•°æ®åˆå§‹åŒ–</h2>
                <div class="btn-group">
                    <button class="btn btn-info" onclick="showQuickPasteModal()">å¿«é€Ÿç²˜è´´è§£æ</button>
                    <button class="btn btn-success" onclick="parseInitData()">è§£æå¹¶åº”ç”¨æ•°æ®</button>
                </div>
            </div>
            
            <div class="init-inputs">
                <div class="init-input">
                    <label for="init-sql-content">SQLå†…å®¹</label>
                    <textarea class="init-textarea" id="init-sql-content" placeholder="åœ¨æ­¤ç²˜è´´SQLå†…å®¹ï¼Œå¦‚ï¼š/*è‡ªåŠ¨ç”ŸæˆæŸ¥è¯¢SQL*/ SELECT * FROM table WHERE id=@id"></textarea>
                    <div class="init-example">
                        ç¤ºä¾‹: <code>/*è‡ªåŠ¨ç”ŸæˆæŸ¥è¯¢SQL*/ SELECT * FROM table WHERE id=@id</code>
                    </div>
                </div>
                
                <div class="init-input">
                    <label for="init-sql-params">SQLå‚æ•°</label>
                    <textarea class="init-textarea" id="init-sql-params" placeholder='åœ¨æ­¤ç²˜è´´SQLå‚æ•°ï¼Œå¦‚ï¼š[{"Name":"@id","PType":"Int32","Value":1}]'></textarea>
                    <div class="init-example">
                        ç¤ºä¾‹: <code>[{"Name":"@id","PType":"Int32","Value":1}]</code>
                    </div>
                </div>
            </div>
            
            <div class="paste-tip">
                ğŸ’¡ æç¤ºï¼šå¯ä»¥ç›´æ¥ç²˜è´´åŒ…å« <code>SQLå†…å®¹:</code> å’Œ <code>SQLå‚æ•°:</code> çš„å®Œæ•´æ—¥å¿—æ–‡æœ¬ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å’Œè§£æ
            </div>
        </div>

        <!-- SQLç¼–è¾‘åŒº -->
        <div class="card">
            <div class="card-header">
                <h2>SQLè¯­å¥ç¼–è¾‘å™¨</h2>
                <div class="btn-group">
                    <button class="btn" onclick="formatSQL()">æ ¼å¼åŒ–SQL</button>
                    <button class="btn" onclick="toggleWordWrap()">åˆ‡æ¢æ¢è¡Œ</button>
                    <button class="btn btn-reset" onclick="resetSQL()">é‡ç½®SQL</button>
                </div>
            </div>
            <textarea class="sql-textarea" id="sql-editor" placeholder="åœ¨æ­¤è¾“å…¥æˆ–ç¼–è¾‘SQLè¯­å¥ï¼ŒåŒ…å«@parameteræ ¼å¼çš„å‚æ•°..." 
                      oninput="onSQLChange()"></textarea>
        </div>

        <!-- å‚æ•°ç¼–è¾‘åŒº -->
        <div class="card">
            <div class="card-header">
                <h2>SQLå‚æ•°ç®¡ç†</h2>
                <div class="btn-group">
                    <button class="btn btn-warning" onclick="parseParamsFromJSON()">ä»JSONè§£æå‚æ•°</button>
                    <button class="btn" onclick="parseParamsFromSQL()">ä»SQLè§£æå‚æ•°</button>
                    <button class="btn btn-reset" onclick="resetParams()">é‡ç½®æ‰€æœ‰å‚æ•°</button>
                </div>
            </div>
            
            <div class="params-container">
                <!-- JSONç¼–è¾‘å™¨ -->
                <div>
                    <div class="section-title">
                        <h3>JSONå‚æ•°æ•°æ®</h3>
                        <button class="json-format-btn" onclick="formatJSON()">æ ¼å¼åŒ–JSON</button>
                    </div>
                    <textarea class="json-editor" id="json-editor" placeholder='è¾“å…¥JSONæ ¼å¼çš„å‚æ•°æ•°ç»„ï¼Œä¾‹å¦‚ï¼š[{"Name": "@id", "PType": "Int32", "Value": 1}]' 
                              oninput="onJSONChange()"></textarea>
                    <div class="parse-hint">
                        <span>æ”¯æŒJSONæ ¼å¼å‚æ•°æ•°ç»„ï¼Œå‚æ•°å°†è‡ªåŠ¨è§£æåˆ°å³ä¾§è¡¨æ ¼</span>
                        <span class="parse-count">å·²è§£æå‚æ•°: <span id="param-count">0</span> ä¸ª</span>
                    </div>
                    <div class="error-message" id="json-error"></div>
                </div>
                
                <!-- å‚æ•°è¡¨æ ¼ -->
                <div>
                    <div class="section-title">
                        <h3>å‚æ•°åˆ—è¡¨</h3>
                        <button class="btn btn-success" onclick="addNewParam()">+ æ·»åŠ å‚æ•°</button>
                    </div>
                    <table class="params-table" id="params-table">
                        <thead>
                            <tr>
                                <th>å‚æ•°å</th>
                                <th>ç±»å‹</th>
                                <th>å€¼</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="params-body">
                            <!-- å‚æ•°è¡Œå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- å®Œæ•´SQLé¢„è§ˆåŒº -->
        <div class="card full-sql-container">
            <div class="card-header">
                <h2>å®Œæ•´SQLé¢„è§ˆï¼ˆå®æ—¶ç”Ÿæˆï¼‰</h2>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="copyFullSQL()">å¤åˆ¶å®Œæ•´SQL</button>
                    <button class="btn" onclick="exportSQL()">å¯¼å‡ºSQLæ–‡ä»¶</button>
                </div>
            </div>
            <pre class="full-sql" id="full-sql"></pre>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="controls">
            <button class="btn" onclick="loadSampleData()">åŠ è½½ç¤ºä¾‹æ•°æ®</button>
            <button class="btn" onclick="loadExtendedSample()">åŠ è½½æ‰©å±•ç¤ºä¾‹</button>
            <button class="btn" onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        </div>

        <footer>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; justify-content: center;">
                <span style="color: var(--text-secondary);">SQLæ—¥å¿—è§£æå™¨ v2.0</span>
                <span style="color: var(--text-secondary);">|</span>
                <a href="https://github.com/kuangmaster" target="_blank" style="text-decoration: none; color: #ffffff; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; padding: 8px 20px; border-radius: 12px;  position: relative;overflow: hidden;">
                    <div style="position: absolute; inset: 0; border-radius: 12px; padding: 1px; background: linear-gradient(135deg, #6c63ff, #ff6584, #36d7b7); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; opacity: 0; transition: opacity 0.4s ease;"></div>
                    <div style="position: absolute; inset: -2px; border-radius: 14px; background: linear-gradient(135deg, #6c63ff, #ff6584, #36d7b7); filter: blur(12px); opacity: 0; transition: opacity 0.4s ease; z-index: -1;"></div>
                    <svg t="1764932904284" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"p-id="2799" width="16" height="16" style="filter: drop-shadow(0 0 4px rgba(18, 7, 228, 0.5));"><path fill="url(#king-gradient)" stroke="url(#king-gradient)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" d="M213.333333 85.333333h170.666667v85.333334H298.666667v85.333333H213.333333V85.333333zM213.333333 512H128V256h85.333333v256zM298.666667 597.333333H213.333333v-85.333333h85.333334v85.333333z" p-id="2800"></path><path fill="url(#king-gradient)" stroke="url(#king-gradient)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" d="M384 682.666667v-85.333334H298.666667v85.333334H128v-85.333334H42.666667v85.333334h85.333333v85.333333h170.666667v170.666667h85.333333v-170.666667h85.333333v-85.333333H384z m0 0v85.333333H298.666667v-85.333333h85.333333z" p-id="2801"></path><path fill="url(#king-gradient)" stroke="url(#king-gradient)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" d="M640 170.666667v85.333333H384V170.666667h256zM810.666667 256h-85.333334V170.666667h-85.333333V85.333333h170.666667v170.666667zM810.666667 512V256h85.333333v256h-85.333333zM725.333333 597.333333v-85.333333h85.333334v85.333333h-85.333334zM640 682.666667v-85.333334h85.333333v85.333334h-85.333333zM640 768h-85.333333v-85.333333h85.333333v85.333333zM640 768h85.333333v170.666667h-85.333333v-170.666667z" p-id="2802"></path><defs> <linearGradient id="king-gradient" x1="0%" y1="0%" x2="100%" y2="100%">  <stop offset="0%" stop-color="#6c63ff" />  <stop offset="50%" stop-color="#ff6584" />  <stop offset="100%" stop-color="#36d7b7" /> </linearGradient></defs></svg>
                    <span style="background: linear-gradient(135deg, #6c63ff, #ff6584, #36d7b7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 700; letter-spacing: 1px;">
                        KUANG
                    </span>
                </a>
                <span style="color: var(--text-secondary);">|</span>
                <span style="color: var(--text-secondary);">PostgreSQLä¸“ç”¨</span>
            </div>
            <div style="font-size: 12px; color: #999;">
                Â© 2025 æ•°æ®è§£æå·¥å…· | é«˜æ•ˆå¤„ç†SQLæ—¥å¿—
            </div>
            </div>
        </footer>


        <!-- å¿«é€Ÿç²˜è´´æ¨¡æ€æ¡† -->
        <div class="modal" id="quick-paste-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>å¿«é€Ÿç²˜è´´è§£æ</h2>
                    <button class="close-btn" onclick="hideQuickPasteModal()">Ã—</button>
                </div>
                <div class="modal-body">
                    <p>ç²˜è´´åŒ…å«ä»¥ä¸‹æ ¼å¼çš„å®Œæ•´æ—¥å¿—æ–‡æœ¬ï¼š</p>
                    <pre style="background: #f5f5f5; padding: 12px; border-radius: 4px; margin: 12px 0; font-size: 13px;">
SQLå†…å®¹:/*è‡ªåŠ¨ç”ŸæˆæŸ¥è¯¢SQL*/ SELECT * FROM qw_base.b_dept WHERE org_id=@org_id AND sno=@sno
SQLå‚æ•°:[{"Name":"@org_id","PType":"String","Value":"8167a03e3dcf"},{"Name":"@sno","PType":"Int32","Value":0}]</pre>
                    
                    <label for="quick-paste-textarea">ç²˜è´´æ—¥å¿—æ–‡æœ¬ï¼š</label>
                    <textarea class="init-textarea" id="quick-paste-textarea" placeholder="åœ¨æ­¤ç²˜è´´å®Œæ•´çš„æ—¥å¿—æ–‡æœ¬..." style="min-height: 200px; margin-top: 8px;"></textarea>
                    
                    <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="btn btn-reset" onclick="hideQuickPasteModal()">å–æ¶ˆ</button>
                        <button class="btn btn-success" onclick="parseQuickPaste()">è§£æå¹¶åº”ç”¨</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- é€šçŸ¥æç¤º -->
        <div class="notification" id="notification"></div>
    </div>

    <script>
        // åˆå§‹åŒ–æ•°æ®
        const sampleData = {
            sqlContent: `/*è‡ªåŠ¨ç”ŸæˆæŸ¥è¯¢SQL*/ SELECT * FROM public.event_bus_events_subscribe WHERE event_id=@event_id AND type=@type`,
            sqlParams: [
                {"Name":"@event_id","PType":"String","Value":"8167a03e3dcf"},
                {"Name":"@type","PType":"Int32","Value":3}
            ]
        };

        // æ‰©å±•ç¤ºä¾‹æ•°æ®ï¼ˆåŒ…å«DateTime2ç­‰ç±»å‹ï¼‰
        const extendedSample = {
            sqlContent: `SELECT * FROM orders 
WHERE order_date >= @startTime 
  AND order_date <= @endTime 
  AND customer_id = @customerId 
  AND status IN (@status1, @status2, @status3) 
  AND total_amount > @minAmount 
  AND is_active = @isActive
ORDER BY order_date DESC`,
            sqlParams: [
                {
                    "Name": "@startTime",
                    "PType": "DateTime2",
                    "Value": "2025-12-05T00:00:00"
                },
                {
                    "Name": "@endTime",
                    "PType": "DateTime2",
                    "Value": "2025-12-05T23:59:59"
                },
                {
                    "Name": "@customerId",
                    "PType": "Int32",
                    "Value": 12345
                },
                {
                    "Name": "@status1",
                    "PType": "String",
                    "Value": "pending"
                },
                {
                    "Name": "@status2",
                    "PType": "String",
                    "Value": "processing"
                },
                {
                    "Name": "@status3",
                    "PType": "String",
                    "Value": "completed"
                },
                {
                    "Name": "@minAmount",
                    "PType": "Decimal",
                    "Value": 100.50
                },
                {
                    "Name": "@isActive",
                    "PType": "Boolean",
                    "Value": true
                }
            ]
        };

        // å­˜å‚¨å½“å‰çŠ¶æ€
        let currentSQL = sampleData.sqlContent;
        let currentParams = [...sampleData.sqlParams];
        let wrapEnabled = true; // é»˜è®¤å¯ç”¨è‡ªåŠ¨æ¢è¡Œ

        // åˆå§‹åŒ–é¡µé¢
        function initPage() {
            // è®¾ç½®åˆå§‹åŒ–çª—å£çš„ç¤ºä¾‹æ•°æ®
            const initExample = {
                sqlContent: "/*è‡ªåŠ¨ç”ŸæˆæŸ¥è¯¢SQL*/ SELECT * FROM public.event_bus_events_subscribe WHERE event_id=@event_id AND type=@type",
                sqlParams: '[{"Name":"@event_id","PType":"String","Value":"5899b07e-176f-9a3e-a327-8167a03e3dcf"},{"Name":"@type","PType":"Int32","Value":3}]'
            };
            
            document.getElementById('init-sql-content').value = initExample.sqlContent;
            document.getElementById('init-sql-params').value = initExample.sqlParams;
            
            // è®¾ç½®SQLç¼–è¾‘å™¨
            document.getElementById('sql-editor').value = currentSQL;
            
            // è®¾ç½®JSONç¼–è¾‘å™¨
            document.getElementById('json-editor').value = JSON.stringify(currentParams, null, 2);
            
            // æ¸²æŸ“å‚æ•°è¡¨æ ¼
            renderParamsTable();
            
            // åˆå§‹æ¸²æŸ“å®Œæ•´SQL
            renderFullSQL();
        }

        // æ˜¾ç¤ºå¿«é€Ÿç²˜è´´æ¨¡æ€æ¡†
        function showQuickPasteModal() {
            document.getElementById('quick-paste-modal').classList.add('show');
            document.getElementById('quick-paste-textarea').focus();
        }

        // éšè—å¿«é€Ÿç²˜è´´æ¨¡æ€æ¡†
        function hideQuickPasteModal() {
            document.getElementById('quick-paste-modal').classList.remove('show');
            document.getElementById('quick-paste-textarea').value = '';
        }

        // è§£æå¿«é€Ÿç²˜è´´çš„å†…å®¹
        function parseQuickPaste() {
            const pasteText = document.getElementById('quick-paste-textarea').value.trim();
            
            if (!pasteText) {
                showNotification('è¯·è¾“å…¥è¦è§£æçš„æ—¥å¿—æ–‡æœ¬', true);
                return;
            }
            
            try {
                const { sqlContent, sqlParams } = parseLogText(pasteText);
                
                if (sqlContent) {
                    document.getElementById('init-sql-content').value = sqlContent;
                }
                
                if (sqlParams) {
                    document.getElementById('init-sql-params').value = sqlParams;
                }
                
                hideQuickPasteModal();
                parseInitData();
                
                showNotification('æ—¥å¿—æ–‡æœ¬è§£ææˆåŠŸå¹¶å·²åº”ç”¨');
            } catch (error) {
                showNotification(`è§£æå¤±è´¥: ${error.message}`, true);
            }
        }

        // è§£ææ—¥å¿—æ–‡æœ¬
        function parseLogText(text) {
            const result = {
                sqlContent: '',
                sqlParams: ''
            };
            
            // è§£æSQLå†…å®¹
            const sqlContentMatch = text.match(/SQLå†…å®¹[:ï¼š]\s*(.+?)(?=\s*(?:SQLå‚æ•°|$))/s);
            if (sqlContentMatch && sqlContentMatch[1]) {
                result.sqlContent = sqlContentMatch[1].trim();
            }
            
            // è§£æSQLå‚æ•°
            const sqlParamsMatch = text.match(/SQLå‚æ•°[:ï¼š]\s*(.+?)(?=\s*(?:$))/s);
            if (sqlParamsMatch && sqlParamsMatch[1]) {
                result.sqlParams = sqlParamsMatch[1].trim();
            }
            
            // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°æ ‡å‡†æ ¼å¼ï¼Œå°è¯•å…¶ä»–æ ¼å¼
            if (!result.sqlContent) {
                // å°è¯•æŸ¥æ‰¾åŒ…å«@parameterçš„SQLè¯­å¥
                const sqlMatch = text.match(/(SELECT|INSERT|UPDATE|DELETE|WITH).+?(?=\s*(?:$|\[|\{))/is);
                if (sqlMatch) {
                    result.sqlContent = sqlMatch[0].trim();
                }
            }
            
            if (!result.sqlParams) {
                // å°è¯•æŸ¥æ‰¾JSONæ•°ç»„
                const jsonMatch = text.match(/\[(\s*\{.*?\}\s*,?\s*)+\]/s);
                if (jsonMatch) {
                    result.sqlParams = jsonMatch[0].trim();
                }
            }
            
            return result;
        }

        // è§£æå¹¶åº”ç”¨åˆå§‹åŒ–æ•°æ®
        function parseInitData() {
            const sqlContentInput = document.getElementById('init-sql-content').value.trim();
            const sqlParamsInput = document.getElementById('init-sql-params').value.trim();
            
            let hasError = false;
            
            // å¤„ç†SQLå†…å®¹
            if (sqlContentInput) {
                currentSQL = sqlContentInput;
                document.getElementById('sql-editor').value = currentSQL;
            } else {
                showNotification('SQLå†…å®¹ä¸èƒ½ä¸ºç©º', true);
                hasError = true;
            }
            
            // å¤„ç†SQLå‚æ•°
            if (sqlParamsInput) {
                try {
                    // å°è¯•è§£æJSON
                    const paramsText = sqlParamsInput.trim();
                    let jsonData;
                    
                    // æ”¯æŒå¤šç§JSONæ ¼å¼
                    if (paramsText.startsWith('[')) {
                        jsonData = JSON.parse(paramsText);
                        if (!Array.isArray(jsonData)) {
                            throw new Error('SQLå‚æ•°å¿…é¡»æ˜¯JSONæ•°ç»„æ ¼å¼');
                        }
                    } else if (paramsText.startsWith('{')) {
                        jsonData = [JSON.parse(paramsText)];
                    } else {
                        // å°è¯•å»æ‰å¯èƒ½çš„ä¸­æ‹¬å·å’Œå¼•å·
                        const cleanText = paramsText.replace(/^\[|\]$/g, '').trim();
                        if (cleanText.startsWith('{')) {
                            jsonData = [JSON.parse(cleanText)];
                        } else {
                            throw new Error('SQLå‚æ•°æ ¼å¼ä¸æ­£ç¡®');
                        }
                    }
                    
                    // æ ‡å‡†åŒ–å‚æ•°
                    const validParams = jsonData.map((item, index) => {
                        if (!item || typeof item !== 'object') {
                            throw new Error(`ç¬¬${index + 1}ä¸ªå‚æ•°ä¸æ˜¯æœ‰æ•ˆçš„å¯¹è±¡`);
                        }
                        
                        // å…¼å®¹ä¸åŒçš„å±æ€§åå¤§å°å†™
                        const name = item.Name || item.name;
                        const ptype = item.PType || item.ptype || item.Type || item.type;
                        const value = item.Value !== undefined ? item.Value : item.value;
                        
                        if (!name || typeof name !== 'string') {
                            throw new Error(`ç¬¬${index + 1}ä¸ªå‚æ•°ç¼ºå°‘æœ‰æ•ˆçš„Nameå­—æ®µ`);
                        }
                        
                        // æ ‡å‡†åŒ–å‚æ•°å
                        const normalizedName = name.startsWith('@') ? name : '@' + name;
                        
                        // æ ‡å‡†åŒ–ç±»å‹
                        let normalizedType = 'String';
                        if (ptype) {
                            const typeLower = ptype.toLowerCase();
                            if (typeLower.includes('int') && typeLower.includes('32')) {
                                normalizedType = 'Int32';
                            } else if (typeLower.includes('int') && typeLower.includes('64')) {
                                normalizedType = 'Int64';
                            } else if (typeLower.includes('decimal') || typeLower.includes('numeric')) {
                                normalizedType = 'Decimal';
                            } else if (typeLower.includes('float') || typeLower.includes('double')) {
                                normalizedType = 'Float';
                            } else if (typeLower.includes('bool')) {
                                normalizedType = 'Boolean';
                            } else if (typeLower.includes('date') || typeLower.includes('time')) {
                                normalizedType = typeLower.includes('2') ? 'DateTime2' : 'DateTime';
                            } else {
                                normalizedType = ptype;
                            }
                        }
                        
                        return {
                            Name: normalizedName,
                            PType: normalizedType,
                            Value: value === undefined ? '' : value
                        };
                    });
                    
                    currentParams = validParams;
                    document.getElementById('json-editor').value = JSON.stringify(currentParams, null, 2);
                    
                    // æ¸²æŸ“å‚æ•°è¡¨æ ¼
                    renderParamsTable();
                    
                } catch (error) {
                    showNotification(`SQLå‚æ•°è§£æå¤±è´¥: ${error.message}`, true);
                    hasError = true;
                }
            } else {
                // å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œæ¸…ç©ºå½“å‰å‚æ•°
                currentParams = [];
                document.getElementById('json-editor').value = '[]';
                renderParamsTable();
            }
            
            // é‡æ–°æ¸²æŸ“å®Œæ•´SQL
            renderFullSQL();
            
            if (!hasError) {
                showNotification('åˆå§‹åŒ–æ•°æ®å·²æˆåŠŸè§£æå¹¶åº”ç”¨');
            }
        }

        // åˆ‡æ¢æ¢è¡Œæ¨¡å¼
        function toggleWordWrap() {
            const textarea = document.getElementById('sql-editor');
            wrapEnabled = !wrapEnabled;
            
            if (wrapEnabled) {
                // å¯ç”¨è‡ªåŠ¨æ¢è¡Œ
                textarea.style.whiteSpace = 'pre-wrap';
                textarea.style.wordWrap = 'break-word';
                textarea.style.wordBreak = 'break-all';
                textarea.style.overflowWrap = 'break-word';
                textarea.style.overflowX = 'hidden';
                showNotification('å·²å¯ç”¨è‡ªåŠ¨æ¢è¡Œ');
            } else {
                // ç¦ç”¨è‡ªåŠ¨æ¢è¡Œï¼Œæ˜¾ç¤ºæ¨ªå‘æ»šåŠ¨æ¡
                textarea.style.whiteSpace = 'pre';
                textarea.style.wordWrap = 'normal';
                textarea.style.wordBreak = 'normal';
                textarea.style.overflowWrap = 'normal';
                textarea.style.overflowX = 'auto';
                showNotification('å·²ç¦ç”¨è‡ªåŠ¨æ¢è¡Œï¼ˆæ˜¾ç¤ºæ¨ªå‘æ»šåŠ¨æ¡ï¼‰');
            }
        }

        // SQLå˜åŒ–æ—¶çš„å¤„ç†
        function onSQLChange() {
            currentSQL = document.getElementById('sql-editor').value;
            renderFullSQL();
        }

        // JSONå˜åŒ–æ—¶çš„å¤„ç†
        function onJSONChange() {
            const jsonEditor = document.getElementById('json-editor');
            const errorDiv = document.getElementById('json-error');
            
            try {
                if (jsonEditor.value.trim()) {
                    let jsonData;
                    
                    // å°è¯•è§£æJSONï¼Œæ”¯æŒå¤šç§æ ¼å¼
                    const jsonText = jsonEditor.value.trim();
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ•°ç»„
                    if (jsonText.startsWith('[')) {
                        jsonData = JSON.parse(jsonText);
                        if (!Array.isArray(jsonData)) {
                            throw new Error('JSONæ•°æ®å¿…é¡»æ˜¯æ•°ç»„æ ¼å¼');
                        }
                    } 
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å•ä¸ªå¯¹è±¡
                    else if (jsonText.startsWith('{')) {
                        const singleObj = JSON.parse(jsonText);
                        jsonData = [singleObj];
                    } 
                    // å…¶ä»–æ ¼å¼æŠ¥é”™
                    else {
                        throw new Error('JSONæ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„æˆ–å¯¹è±¡');
                    }
                    
                    // éªŒè¯å’Œæ ‡å‡†åŒ–JSONç»“æ„
                    const validParams = jsonData.map((item, index) => {
                        if (!item || typeof item !== 'object') {
                            throw new Error(`ç¬¬${index + 1}ä¸ªå‚æ•°ä¸æ˜¯æœ‰æ•ˆçš„å¯¹è±¡`);
                        }
                        
                        // å…¼å®¹ä¸åŒçš„å±æ€§åå¤§å°å†™
                        const name = item.Name || item.name;
                        const ptype = item.PType || item.ptype || item.Type || item.type;
                        const value = item.Value !== undefined ? item.Value : item.value;
                        
                        if (!name || typeof name !== 'string') {
                            throw new Error(`ç¬¬${index + 1}ä¸ªå‚æ•°ç¼ºå°‘æœ‰æ•ˆçš„Nameå­—æ®µ`);
                        }
                        
                        // æ ‡å‡†åŒ–å‚æ•°åï¼ˆç¡®ä¿ä»¥@å¼€å¤´ï¼‰
                        const normalizedName = name.startsWith('@') ? name : '@' + name;
                        
                        // æ ‡å‡†åŒ–ç±»å‹
                        let normalizedType = 'String'; // é»˜è®¤ç±»å‹
                        if (ptype) {
                            // å¤„ç†å¸¸è§çš„ç±»å‹å˜ä½“
                            const typeLower = ptype.toLowerCase();
                            if (typeLower.includes('int') && typeLower.includes('32')) {
                                normalizedType = 'Int32';
                            } else if (typeLower.includes('int') && typeLower.includes('64')) {
                                normalizedType = 'Int64';
                            } else if (typeLower.includes('decimal') || typeLower.includes('numeric')) {
                                normalizedType = 'Decimal';
                            } else if (typeLower.includes('float') || typeLower.includes('double')) {
                                normalizedType = 'Float';
                            } else if (typeLower.includes('bool')) {
                                normalizedType = 'Boolean';
                            } else if (typeLower.includes('date') || typeLower.includes('time')) {
                                // æ”¯æŒå„ç§æ—¥æœŸæ—¶é—´ç±»å‹
                                normalizedType = typeLower.includes('2') ? 'DateTime2' : 'DateTime';
                            } else if (typeLower.includes('string') || typeLower.includes('varchar') || typeLower.includes('text')) {
                                normalizedType = 'String';
                            } else {
                                normalizedType = ptype; // ä¿æŒåŸæ ·
                            }
                        }
                        
                        return {
                            Name: normalizedName,
                            PType: normalizedType,
                            Value: value === undefined ? '' : value
                        };
                    });
                    
                    currentParams = validParams;
                    renderParamsTable();
                    renderFullSQL();
                    errorDiv.classList.remove('show');
                }
            } catch (error) {
                errorDiv.textContent = `JSONè§£æé”™è¯¯: ${error.message}`;
                errorDiv.classList.add('show');
            }
        }

        // ä»JSONè§£æå‚æ•°ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
        function parseParamsFromJSON() {
            const jsonEditor = document.getElementById('json-editor');
            const errorDiv = document.getElementById('json-error');
            
            try {
                if (jsonEditor.value.trim()) {
                    let jsonData;
                    const jsonText = jsonEditor.value.trim();
                    
                    // æ”¯æŒå¤šç§JSONæ ¼å¼
                    if (jsonText.startsWith('[')) {
                        jsonData = JSON.parse(jsonText);
                        if (!Array.isArray(jsonData)) {
                            throw new Error('JSONæ•°æ®å¿…é¡»æ˜¯æ•°ç»„æ ¼å¼');
                        }
                    } else if (jsonText.startsWith('{')) {
                        const singleObj = JSON.parse(jsonText);
                        jsonData = [singleObj];
                    } else {
                        throw new Error('JSONæ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„æˆ–å¯¹è±¡');
                    }
                    
                    // éªŒè¯å’Œæ ‡å‡†åŒ–JSONç»“æ„
                    const validParams = jsonData.map((item, index) => {
                        if (!item || typeof item !== 'object') {
                            throw new Error(`ç¬¬${index + 1}ä¸ªå‚æ•°ä¸æ˜¯æœ‰æ•ˆçš„å¯¹è±¡`);
                        }
                        
                        // å…¼å®¹ä¸åŒçš„å±æ€§åå¤§å°å†™
                        const name = item.Name || item.name;
                        const ptype = item.PType || item.ptype || item.Type || item.type;
                        const value = item.Value !== undefined ? item.Value : item.value;
                        
                        if (!name || typeof name !== 'string') {
                            throw new Error(`ç¬¬${index + 1}ä¸ªå‚æ•°ç¼ºå°‘æœ‰æ•ˆçš„Nameå­—æ®µ`);
                        }
                        
                        // æ ‡å‡†åŒ–å‚æ•°å
                        const normalizedName = name.startsWith('@') ? name : '@' + name;
                        
                        // æ ‡å‡†åŒ–ç±»å‹
                        let normalizedType = 'String';
                        if (ptype) {
                            const typeLower = ptype.toLowerCase();
                            if (typeLower.includes('int') && typeLower.includes('32')) {
                                normalizedType = 'Int32';
                            } else if (typeLower.includes('int') && typeLower.includes('64')) {
                                normalizedType = 'Int64';
                            } else if (typeLower.includes('decimal') || typeLower.includes('numeric')) {
                                normalizedType = 'Decimal';
                            } else if (typeLower.includes('float') || typeLower.includes('double')) {
                                normalizedType = 'Float';
                            } else if (typeLower.includes('bool')) {
                                normalizedType = 'Boolean';
                            } else if (typeLower.includes('date') || typeLower.includes('time')) {
                                normalizedType = typeLower.includes('2') ? 'DateTime2' : 'DateTime';
                            } else if (typeLower.includes('string') || typeLower.includes('varchar') || typeLower.includes('text')) {
                                normalizedType = 'String';
                            } else {
                                normalizedType = ptype;
                            }
                        }
                        
                        return {
                            Name: normalizedName,
                            PType: normalizedType,
                            Value: value === undefined ? '' : value
                        };
                    });
                    
                    currentParams = validParams;
                    renderParamsTable();
                    renderFullSQL();
                    
                    // æ›´æ–°JSONç¼–è¾‘å™¨ï¼ˆæ ‡å‡†åŒ–æ ¼å¼ï¼‰
                    jsonEditor.value = JSON.stringify(currentParams, null, 2);
                    
                    errorDiv.classList.remove('show');
                    showNotification(`ä»JSONæˆåŠŸè§£æ ${validParams.length} ä¸ªå‚æ•°`);
                } else {
                    showNotification('JSONç¼–è¾‘å™¨ä¸ºç©ºï¼Œè¯·è¾“å…¥JSONæ•°æ®', true);
                }
            } catch (error) {
                errorDiv.textContent = `JSONè§£æé”™è¯¯: ${error.message}`;
                errorDiv.classList.add('show');
                showNotification('JSONè§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼', true);
            }
        }

        // ä»SQLè¯­å¥ä¸­è§£æå‚æ•°
        function parseParamsFromSQL() {
            const sql = document.getElementById('sql-editor').value;
            
            // æå–æ‰€æœ‰@å¼€å¤´çš„å‚æ•°å
            const paramRegex = /@[a-zA-Z_][a-zA-Z0-9_]*/g;
            const matches = sql.match(paramRegex);
            
            if (matches) {
                // å»é‡å¹¶åˆ›å»ºå‚æ•°å¯¹è±¡
                const uniqueParams = [...new Set(matches)];
                const newParams = uniqueParams.map(paramName => {
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥å‚æ•°
                    const existingParam = currentParams.find(p => p.Name === paramName);
                    if (existingParam) {
                        return existingParam;
                    }
                    
                    // åˆ›å»ºæ–°å‚æ•°
                    return {
                        Name: paramName,
                        PType: 'String', // é»˜è®¤ç±»å‹
                        Value: ''
                    };
                });
                
                currentParams = newParams;
                renderParamsTable();
                
                // æ›´æ–°JSONç¼–è¾‘å™¨
                document.getElementById('json-editor').value = JSON.stringify(currentParams, null, 2);
                
                showNotification(`ä»SQLè¯­å¥ä¸­è§£æå‡º ${newParams.length} ä¸ªå‚æ•°`);
            } else {
                showNotification('SQLè¯­å¥ä¸­æ²¡æœ‰æ‰¾åˆ°å‚æ•°ï¼ˆ@parameteræ ¼å¼ï¼‰', true);
            }
        }

        // æ¸²æŸ“å‚æ•°è¡¨æ ¼
        function renderParamsTable() {
            const paramsBody = document.getElementById('params-body');
            paramsBody.innerHTML = '';

            currentParams.forEach((param, index) => {
                const isDateTimeType = param.PType.includes('DateTime') || param.PType.includes('date') || param.PType.includes('time');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="text" 
                               class="param-input" 
                               value="${param.Name}" 
                               data-field="name"
                               data-index="${index}"
                               onchange="updateParamField(${index}, 'Name', this.value)">
                    </td>
                    <td>
                        <select class="param-input" 
                                data-field="type"
                                data-index="${index}"
                                onchange="updateParamField(${index}, 'PType', this.value)">
                            <option value="String" ${param.PType === 'String' ? 'selected' : ''}>String</option>
                            <option value="Int32" ${param.PType === 'Int32' ? 'selected' : ''}>Int32</option>
                            <option value="Int64" ${param.PType === 'Int64' ? 'selected' : ''}>Int64</option>
                            <option value="Decimal" ${param.PType === 'Decimal' ? 'selected' : ''}>Decimal</option>
                            <option value="Float" ${param.PType === 'Float' ? 'selected' : ''}>Float</option>
                            <option value="Boolean" ${param.PType === 'Boolean' ? 'selected' : ''}>Boolean</option>
                            <option value="DateTime" ${param.PType === 'DateTime' ? 'selected' : ''}>DateTime</option>
                            <option value="DateTime2" ${param.PType === 'DateTime2' ? 'selected' : ''}>DateTime2</option>
                            <option value="Date" ${param.PType === 'Date' ? 'selected' : ''}>Date</option>
                            <option value="Time" ${param.PType === 'Time' ? 'selected' : ''}>Time</option>
                        </select>
                    </td>
                    <td>
                        ${isDateTimeType ? `
                            <input type="datetime-local" 
                                   class="param-input datetime-input" 
                                   value="${formatDateTimeForInput(param.Value)}" 
                                   data-field="value"
                                   data-index="${index}"
                                   onchange="updateParamField(${index}, 'Value', this.value)">
                        ` : `
                            <input type="text" 
                                   class="param-input" 
                                   value="${param.Value || ''}" 
                                   data-field="value"
                                   data-index="${index}"
                                   onchange="updateParamField(${index}, 'Value', this.value)">
                        `}
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn" onclick="moveParamUp(${index})" ${index === 0 ? 'disabled' : ''} title="ä¸Šç§»">â†‘</button>
                            <button class="btn" onclick="moveParamDown(${index})" ${index === currentParams.length - 1 ? 'disabled' : ''} title="ä¸‹ç§»">â†“</button>
                            <button class="btn btn-reset" onclick="removeParam(${index})" title="åˆ é™¤">Ã—</button>
                        </div>
                    </td>
                `;
                paramsBody.appendChild(row);
            });

            // æ›´æ–°å‚æ•°è®¡æ•°
            document.getElementById('param-count').textContent = currentParams.length;

            // å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œæ˜¾ç¤ºæç¤º
            if (currentParams.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="4" style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        æ²¡æœ‰å‚æ•°ï¼Œè¯·æ·»åŠ æˆ–ä»JSON/SQLè§£æå‚æ•°
                    </td>
                `;
                paramsBody.appendChild(row);
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ç”¨äºinput[type="datetime-local"]
        function formatDateTimeForInput(dateTimeStr) {
            if (!dateTimeStr) return '';
            
            try {
                // å°è¯•è§£æå„ç§æ—¥æœŸæ—¶é—´æ ¼å¼
                let date;
                
                if (typeof dateTimeStr === 'string') {
                    // ç§»é™¤å¯èƒ½çš„å¼•å·
                    const cleanStr = dateTimeStr.replace(/^['"]|['"]$/g, '');
                    
                    // å°è¯•è§£æISOæ ¼å¼
                    date = new Date(cleanStr);
                    
                    // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ ¼å¼
                    if (isNaN(date.getTime())) {
                        // å°è¯•yyyy-MM-dd HH:mm:ssæ ¼å¼
                        const match = cleanStr.match(/^(\d{4})-(\d{2})-(\d{2})[T\s](\d{2}):(\d{2}):(\d{2})/);
                        if (match) {
                            date = new Date(match[1], match[2] - 1, match[3], match[4], match[5], match[6]);
                        }
                    }
                } else if (dateTimeStr instanceof Date) {
                    date = dateTimeStr;
                } else {
                    return '';
                }
                
                if (isNaN(date.getTime())) {
                    return '';
                }
                
                // è½¬æ¢ä¸ºdatetime-localéœ€è¦çš„æ ¼å¼ï¼šYYYY-MM-DDTHH:mm
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            } catch (error) {
                console.error('æ—¥æœŸæ—¶é—´æ ¼å¼åŒ–é”™è¯¯:', error);
                return '';
            }
        }

        // æ›´æ–°å‚æ•°å­—æ®µ
        function updateParamField(index, field, value) {
            if (index >= 0 && index < currentParams.length) {
                // æ ¹æ®å­—æ®µç±»å‹è¿›è¡ŒéªŒè¯å’Œè½¬æ¢
                if (field === 'Name') {
                    // ç¡®ä¿å‚æ•°åä»¥@å¼€å¤´
                    if (!value.startsWith('@')) {
                        value = '@' + value;
                    }
                    currentParams[index][field] = value;
                    
                    // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º
                    const input = document.querySelector(`input[data-index="${index}"][data-field="name"]`);
                    if (input) {
                        input.value = value;
                    }
                } else if (field === 'Value') {
                    // æ ¹æ®å‚æ•°ç±»å‹éªŒè¯å€¼
                    const paramType = currentParams[index].PType;
                    let validatedValue = value;
                    
                    if (paramType === 'Int32' || paramType === 'Int64') {
                        validatedValue = parseInt(value) || 0;
                    } else if (paramType === 'Decimal' || paramType === 'Float') {
                        validatedValue = parseFloat(value) || 0;
                    } else if (paramType === 'Boolean') {
                        if (typeof value === 'string') {
                            validatedValue = value.toLowerCase() === 'true' || value === '1';
                        } else {
                            validatedValue = Boolean(value);
                        }
                    } else if (paramType.includes('DateTime') || paramType.includes('Date') || paramType.includes('Time')) {
                        // æ—¥æœŸæ—¶é—´ç±»å‹å¤„ç†
                        if (value) {
                            // å¦‚æœæ˜¯datetime-localè¾“å…¥ï¼Œå·²ç»æ˜¯æ­£ç¡®çš„æ ¼å¼
                            validatedValue = value;
                        } else {
                            validatedValue = '';
                        }
                    } else if (paramType === 'String') {
                        // ç§»é™¤å¯èƒ½çš„å¤šä½™å¼•å·
                        validatedValue = value.replace(/^['"]|['"]$/g, '');
                    }
                    
                    currentParams[index][field] = validatedValue;
                    
                    // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º
                    const input = document.querySelector(`[data-index="${index}"][data-field="value"]`);
                    if (input) {
                        if (paramType.includes('DateTime') || paramType.includes('Date') || paramType.includes('Time')) {
                            input.value = formatDateTimeForInput(validatedValue);
                        } else {
                            input.value = validatedValue;
                        }
                    }
                } else if (field === 'PType') {
                    const oldType = currentParams[index].PType;
                    currentParams[index][field] = value;
                    
                    // å¦‚æœç±»å‹ä»éæ—¥æœŸæ—¶é—´æ”¹ä¸ºæ—¥æœŸæ—¶é—´ï¼Œæˆ–åä¹‹ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
                    const wasDateTime = oldType.includes('DateTime') || oldType.includes('Date') || oldType.includes('Time');
                    const isDateTime = value.includes('DateTime') || value.includes('Date') || value.includes('Time');
                    
                    if (wasDateTime !== isDateTime) {
                        // ç±»å‹å˜åŒ–è¾ƒå¤§ï¼Œéœ€è¦é‡æ–°æ¸²æŸ“è¡¨æ ¼è¡Œ
                        renderParamsTable();
                    } else if (currentParams[index].Value !== undefined) {
                        // åŒä¸€å¤§ç±»å†…çš„ç±»å‹å˜åŒ–ï¼Œæ›´æ–°å€¼
                        updateParamField(index, 'Value', currentParams[index].Value);
                    }
                }
                
                // æ›´æ–°JSONç¼–è¾‘å™¨
                document.getElementById('json-editor').value = JSON.stringify(currentParams, null, 2);
                
                // é‡æ–°æ¸²æŸ“å®Œæ•´SQL
                renderFullSQL();
            }
        }

        // æ·»åŠ æ–°å‚æ•°
        function addNewParam() {
            const newParam = {
                Name: `@param_${currentParams.length + 1}`,
                PType: 'String',
                Value: ''
            };
            
            currentParams.push(newParam);
            renderParamsTable();
            
            // æ›´æ–°JSONç¼–è¾‘å™¨
            document.getElementById('json-editor').value = JSON.stringify(currentParams, null, 2);
            
            // æ»šåŠ¨åˆ°æ–°æ·»åŠ çš„è¡Œ
            const paramsBody = document.getElementById('params-body');
            const lastRow = paramsBody.lastElementChild;
            if (lastRow) {
                lastRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            showNotification('å·²æ·»åŠ æ–°å‚æ•°');
        }

        // ç§»é™¤å‚æ•°
        function removeParam(index) {
            if (index >= 0 && index < currentParams.length) {
                const paramName = currentParams[index].Name;
                currentParams.splice(index, 1);
                renderParamsTable();
                
                // æ›´æ–°JSONç¼–è¾‘å™¨
                document.getElementById('json-editor').value = JSON.stringify(currentParams, null, 2);
                
                // é‡æ–°æ¸²æŸ“å®Œæ•´SQL
                renderFullSQL();
                
                showNotification(`å·²åˆ é™¤å‚æ•°: ${paramName}`);
            }
        }

        // ç§»åŠ¨å‚æ•°ä½ç½®
        function moveParamUp(index) {
            if (index > 0 && index < currentParams.length) {
                const temp = currentParams[index];
                currentParams[index] = currentParams[index - 1];
                currentParams[index - 1] = temp;
                renderParamsTable();
                renderFullSQL();
            }
        }

        function moveParamDown(index) {
            if (index >= 0 && index < currentParams.length - 1) {
                const temp = currentParams[index];
                currentParams[index] = currentParams[index + 1];
                currentParams[index + 1] = temp;
                renderParamsTable();
                renderFullSQL();
            }
        }

        // é‡ç½®æ‰€æœ‰å‚æ•°
        function resetParams() {
            currentParams = [];
            renderParamsTable();
            document.getElementById('json-editor').value = '[]';
            renderFullSQL();
            showNotification('å·²é‡ç½®æ‰€æœ‰å‚æ•°');
        }

        // é‡ç½®SQL
        function resetSQL() {
            currentSQL = sampleData.sqlContent;
            document.getElementById('sql-editor').value = currentSQL;
            renderFullSQL();
            showNotification('SQLå·²é‡ç½®ä¸ºç¤ºä¾‹æ•°æ®');
        }

        // æ ¼å¼åŒ–JSON
        function formatJSON() {
            const jsonEditor = document.getElementById('json-editor');
            const errorDiv = document.getElementById('json-error');
            
            try {
                if (jsonEditor.value.trim()) {
                    let jsonData;
                    const jsonText = jsonEditor.value.trim();
                    
                    if (jsonText.startsWith('[')) {
                        jsonData = JSON.parse(jsonText);
                    } else if (jsonText.startsWith('{')) {
                        jsonData = [JSON.parse(jsonText)];
                    } else {
                        throw new Error('JSONæ ¼å¼ä¸æ­£ç¡®');
                    }
                    
                    jsonEditor.value = JSON.stringify(jsonData, null, 2);
                    errorDiv.classList.remove('show');
                    showNotification('JSONå·²æ ¼å¼åŒ–');
                }
            } catch (error) {
                errorDiv.textContent = `JSONæ ¼å¼åŒ–é”™è¯¯: ${error.message}`;
                errorDiv.classList.add('show');
            }
        }

        // æ ¼å¼åŒ–SQL
        function formatSQL() {
            const sqlEditor = document.getElementById('sql-editor');
            let sql = sqlEditor.value;
            
            // ç®€å•çš„SQLæ ¼å¼åŒ–è§„åˆ™
            sql = sql
                .replace(/\b(SELECT|FROM|WHERE|JOIN|LEFT|RIGHT|INNER|OUTER|ON|AND|OR|ORDER BY|GROUP BY|HAVING|CASE|WHEN|THEN|ELSE|END)\b/gi, '\n$1')
                .replace(/,/g, ',\n    ')
                .replace(/\n\s*\n/g, '\n')
                .replace(/^\s+/gm, '    ');
            
            sqlEditor.value = sql;
            currentSQL = sql;
            renderFullSQL();
            showNotification('SQLå·²æ ¼å¼åŒ–');
        }

        // æ¸²æŸ“å®Œæ•´SQLï¼ˆæ›¿æ¢å‚æ•°ï¼‰
        function renderFullSQL() {
            let fullSQL = currentSQL;
            
            // æŒ‰å‚æ•°åé•¿åº¦é™åºæ’åºï¼Œé¿å…æ›¿æ¢æ—¶å‡ºç°éƒ¨åˆ†åŒ¹é…é—®é¢˜
            const sortedParams = [...currentParams].sort((a, b) => b.Name.length - a.Name.length);
            
            sortedParams.forEach(param => {
                // æ ¹æ®å‚æ•°ç±»å‹æ ¼å¼åŒ–å€¼
                let formattedValue;
                const paramType = param.PType.toLowerCase();
                
                if (paramType.includes('string') || paramType.includes('varchar') || paramType.includes('text')) {
                    formattedValue = `'${param.Value}'`;
                } else if (paramType.includes('date') || paramType.includes('time')) {
                    // æ—¥æœŸæ—¶é—´ç±»å‹
                    if (param.Value) {
                        // å°è¯•æ ¼å¼åŒ–ä¸ºPostgreSQLæ—¥æœŸæ—¶é—´æ ¼å¼
                        try {
                            const dateStr = param.Value.toString().replace(/^['"]|['"]$/g, '');
                            if (dateStr.includes('T') || dateStr.includes(' ')) {
                                // ISOæ ¼å¼æˆ–ç±»ä¼¼æ ¼å¼
                                formattedValue = `'${dateStr}'`;
                            } else {
                                formattedValue = `'${param.Value}'`;
                            }
                        } catch (error) {
                            formattedValue = `'${param.Value}'`;
                        }
                    } else {
                        formattedValue = 'NULL';
                    }
                } else if (paramType.includes('bool')) {
                    formattedValue = param.Value ? 'TRUE' : 'FALSE';
                } else if (param.Value === '' || param.Value === null || param.Value === undefined) {
                    formattedValue = 'NULL';
                } else {
                    formattedValue = param.Value;
                }
                
                // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œå…¨å±€æ›¿æ¢
                const regex = new RegExp(param.Name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                fullSQL = fullSQL.replace(regex, formattedValue);
            });
            
            // åº”ç”¨è¯­æ³•é«˜äº®
            document.getElementById('full-sql').innerHTML = highlightSQL(fullSQL);
        }

        // SQLè¯­æ³•é«˜äº®
        function highlightSQL(sql) {
            // SQLå…³é”®å­—
            const keywords = [
                'select', 'from', 'where', 'join', 'left', 'right', 'inner', 'outer',
                'on', 'and', 'or', 'not', 'in', 'like', 'between', 'is', 'null',
                'case', 'when', 'then', 'else', 'end', 'as', 'order', 'by', 'desc',
                'asc', 'group', 'having', 'insert', 'into', 'update', 'delete',
                'create', 'table', 'view', 'index', 'drop', 'alter', 'add', 'column',
                'primary', 'key', 'foreign', 'references', 'unique', 'check', 'default',
                'values', 'set', 'distinct', 'count', 'sum', 'avg', 'min', 'max',
                'coalesce', 'cast', 'convert', 'type', 'with', 'recursive', 'union',
                'all', 'exists', 'any', 'some'
            ];
            
            let highlighted = sql;
            
            // æ³¨é‡Š
            highlighted = highlighted.replace(/\/\*[\s\S]*?\*\//g, '<span class="sql-comment">$&</span>');
            highlighted = highlighted.replace(/--.*$/gm, '<span class="sql-comment">$&</span>');
            
            // å­—ç¬¦ä¸²
            highlighted = highlighted.replace(/'([^'\\]*(\\.[^'\\]*)*)'/g, '<span class="sql-string">\'$1\'</span>');
            
            // æ•°å­—
            highlighted = highlighted.replace(/\b\d+(\.\d+)?\b/g, '<span class="sql-number">$&</span>');
            
            // å…³é”®å­—
            keywords.forEach(keyword => {
                const regex = new RegExp(`\\b${keyword}\\b`, 'gi');
                highlighted = highlighted.replace(regex, '<span class="sql-keyword">$&</span>');
            });
            
            return highlighted;
        }

        // å¤åˆ¶å®Œæ•´SQLåˆ°å‰ªè´´æ¿
        function copyFullSQL() {
            const fullSQLText = document.getElementById('full-sql').textContent;
            
            navigator.clipboard.writeText(fullSQLText)
                .then(() => {
                    showNotification('å®Œæ•´SQLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                })
                .catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶', true);
                });
        }

        // å¯¼å‡ºSQLæ–‡ä»¶
        function exportSQL() {
            const fullSQLText = document.getElementById('full-sql').textContent;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
            const filename = `sql_export_${timestamp}.sql`;
            
            const blob = new Blob([fullSQLText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('SQLæ–‡ä»¶å·²å¯¼å‡º');
        }

        // åŠ è½½ç¤ºä¾‹æ•°æ®
        function loadSampleData() {
            currentSQL = sampleData.sqlContent;
            currentParams = JSON.parse(JSON.stringify(sampleData.sqlParams));
            
            document.getElementById('sql-editor').value = currentSQL;
            document.getElementById('json-editor').value = JSON.stringify(currentParams, null, 2);
            
            // åŒæ—¶æ›´æ–°åˆå§‹åŒ–çª—å£
            document.getElementById('init-sql-content').value = currentSQL;
            document.getElementById('init-sql-params').value = JSON.stringify(currentParams, null, 2);
            
            renderParamsTable();
            renderFullSQL();
            
            showNotification('ç¤ºä¾‹æ•°æ®å·²åŠ è½½');
        }

        // åŠ è½½æ‰©å±•ç¤ºä¾‹
        function loadExtendedSample() {
            currentSQL = extendedSample.sqlContent;
            currentParams = JSON.parse(JSON.stringify(extendedSample.sqlParams));
            
            document.getElementById('sql-editor').value = currentSQL;
            document.getElementById('json-editor').value = JSON.stringify(currentParams, null, 2);
            
            // åŒæ—¶æ›´æ–°åˆå§‹åŒ–çª—å£
            document.getElementById('init-sql-content').value = currentSQL;
            document.getElementById('init-sql-params').value = JSON.stringify(currentParams, null, 2);
            
            renderParamsTable();
            renderFullSQL();
            
            showNotification('æ‰©å±•ç¤ºä¾‹å·²åŠ è½½ï¼ˆåŒ…å«DateTime2ç­‰ç±»å‹ï¼‰');
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™åŒ…æ‹¬SQLè¯­å¥å’Œæ‰€æœ‰å‚æ•°ã€‚')) {
                currentSQL = '';
                currentParams = [];
                
                document.getElementById('sql-editor').value = '';
                document.getElementById('json-editor').value = '[]';
                document.getElementById('init-sql-content').value = '';
                document.getElementById('init-sql-params').value = '';
                
                renderParamsTable();
                renderFullSQL();
                
                showNotification('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥æç¤º
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            notification.classList.add('show');
            
            if (isError) {
                notification.classList.add('error');
            } else if (message.includes('ç¦ç”¨')) {
                notification.classList.add('warning');
            } else if (message.includes('å¿«é€Ÿç²˜è´´') || message.includes('åˆå§‹åŒ–')) {
                notification.classList.add('info');
            }
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initPage);

        // å…¬å¼€APIä¾›æ‰©å±•ä½¿ç”¨
        window.SQLLogParser = {
            getCurrentSQL: () => currentSQL,
            getCurrentParams: () => currentParams,
            setSQL: (sql) => {
                currentSQL = sql;
                document.getElementById('sql-editor').value = sql;
                renderFullSQL();
            },
            setParams: (params) => {
                currentParams = params;
                document.getElementById('json-editor').value = JSON.stringify(params, null, 2);
                renderParamsTable();
                renderFullSQL();
            },
            toggleWordWrap: toggleWordWrap,
            parseLogText: parseLogText
        };
    </script>
</body>
</html>